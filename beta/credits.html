<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stream Credits</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@900&display=swap" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=News+Cycle:wght@400;700&display=swap" rel="stylesheet" />

	<script type="text/javascript" src="currency.js"></script>
	
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            background-image: url("./media/stardust.png");
            animation: stars 30s linear infinite;
            overflow: hidden;
            opacity: 0;
            transition: opacity 2s;
        }

        body.visible {
            opacity: 1;
        }

        @keyframes stars {
            0% { background-position: 0 0; }
            100% { background-position: 798px -798px; }
        }
		

		/* Star Wars style (default) */
		@keyframes translateText {
			0% {
				transform: rotateX(20deg) scale(1.0, 1.0) translateY(66vh);
			}
			
			10% {
				transform: rotateX(25deg) scale(0.965, .95) translateY(-315.6vh);
			}
			
			100% {
				transform: rotateX(30deg) scale(0.65, 0.5) translateY(-3750vh);
			}
		}


		/* Minimal style */
		@keyframes minimalScroll {
			0% {
				/* Use dynamic start offset; fallback keeps old behavior */
				transform: translateY(var(--start-offset, 100vh));
				opacity: 0;
			}
			
			5% {
				opacity: 1;
			}
			
			95% {
				opacity: 1;
			}
			
			100% {
				/* Use dynamic end offset; fallback keeps old behavior */
				transform: translateY(calc(-1 * var(--end-offset, 300vh)));
				opacity: 0;
			}
		}

		/* Elegant style */
		@keyframes elegantFade {
			0% {
				/* Use dynamic start offset; fallback keeps old behavior */
				transform: translateY(var(--start-offset, 50vh));
				opacity: 0;
			}
			
			5% {
				opacity: 1;
			}
			
			95% {
				opacity: 1;
			}
			
			100% {
				/* Use dynamic end offset; fallback keeps old behavior */
				transform: translateY(calc(-1 * var(--end-offset, 300vh)));
				opacity: 0;
			}
		}

		.text {
			font-size: 9vh;
			line-height: 1.4;
			color: var(--text-color, #ebbc3c);
			text-align: center;
			text-shadow: 0 0 16px #ffeb3b60, 0 0 3px #3bbeff88, 0 0 10px #ffffff83;
			width: 100%;
			margin: 0 auto;
			transform: translateZ(0);
		}

		.category-header {
			font-size: 11vh;
			color: var(--text-color, #ebbc3c);
			margin: 2.5em 0 0.8em;
			text-shadow: 0 0 16px #ffeb3b60, 0 0 3px #3bbeff88, 0 0 10px #ffffff83;
			text-transform: uppercase;
		}

		#app {
			width: 100vw;
			height: 100vh;
			/* font-family: "Nunito Sans", sans-serif; */ /* Remove or comment out this line */
			perspective: 400px;
			perspective-origin: center 100%;
			overflow: hidden;
			display: none;
		}
       
	    #app.starwars {
			perspective: 400px;
			perspective-origin: center 100%;
		}

		.text.starwars, .category-header.starwars {
			font-family: 'News Gothic MT', 'News Gothic', sans-serif;
			font-weight: 700;
			letter-spacing: 0.1em;
			text-transform: uppercase;
			color: #feda4a;
			text-shadow: 0 0 16px rgba(255, 235, 59, 0.6), 0 0 3px rgba(59, 190, 255, 0.8), 0 0 10px rgba(255, 255, 255, 0.3);
			line-height: 1.6;
		}
		
		.category-header.starwars {
			transform: scaleY(1.8); /* Makes the text 30% taller without affecting width */
			transform-origin: center; /* Centers the scaling effect */
			padding: 3px 0; 
		}

        #app.standard {
            perspective: none;
        }

        #app.minimal {
            perspective: none;
        }

        #app.elegant {
            perspective: none;
        }

        #app.visible {
            display: block;
        }

        .logo-container img {
            max-width: 200px;
            height: auto;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.9));
        }

        .logo-container {
            text-align: center;
            padding-top: 120px;
            position: absolute;
            top: 0;
            width: 100%;
            z-index: 20;
        }

        .background {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: #0a123630;
            background-size: cover;
        }

        .fade {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: 50vh;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0),  rgba(0, 0, 0, .1), rgba(0, 0, 0, .3), rgba(0, 0, 0, .8));
            z-index: 10;
        }
		
		.text-container {
			position: relative;
			width: 100%;
			height: 100%;
			padding-top: 120px;
			/* Reduced translateY to start closer to visible area */
			transform: rotateX(25deg) scale(0.4, 0.6) translateY(50vh);
		}

        /* Style-specific class overrides */
        .text-container.starwars {
            transform: rotateX(25deg) scale(0.4, 0.6) translateY(50vh);
        }

        .text-container.standard {
            transform: translateY(100vh);
        }

        .text-container.minimal {
            transform: translateY(100vh);
        }

        .text-container.elegant {
            transform: translateY(50vh);
        }

		.text-container.animate.starwars {
			animation-name: translateText;
		}

        .text-container.animate.standard {
            animation-name: standardRoll;
        }

        .text-container.animate.minimal {
            animation-name: minimalScroll;
        }

        .text-container.animate.elegant {
            animation-name: elegantFade;
        }

        .text-container.animate {
			animation-duration: 600s;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
		}



        .stars {
			overflow: visible;
			position: fixed; /* Changed from absolute to fixed */
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			pointer-events: none;
		}

		.stars:nth-child(1) {
			background-image: 
				radial-gradient(1px 1px at 20px 30px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 40px 70px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 50px 160px, #fff, rgba(0,0,0,0)),
				radial-gradient(2px 2px at 90px 40px, #fff, rgba(0,0,0,0)),
				radial-gradient(2px 2px at 130px 80px, #fff, rgba(0,0,0,0));
			background-repeat: repeat;
			background-size: 200px 200px;
			animation: twinkle 4s infinite, starMove 1200s linear infinite;
			opacity: 0.5;
		}

		.stars:nth-child(2) {
			background-image: 
				radial-gradient(1px 1px at 25px 35px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 45px 75px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 55px 165px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 95px 45px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 135px 85px, #fff, rgba(0,0,0,0));
			background-repeat: repeat;
			background-size: 300px 300px;
			animation: twinkle 6s infinite, starMove 1200s linear infinite;
			opacity: 0.4;
		}

		.stars:nth-child(3) {
			background-image: 
				radial-gradient(1px 1px at 30px 40px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 50px 80px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 60px 170px, #fff, rgba(0,0,0,0)),
				radial-gradient(1.5px 1.5px at 100px 50px, #fff, rgba(0,0,0,0)),
				radial-gradient(1.5px 1.5px at 140px 90px, #fff, rgba(0,0,0,0));
			background-repeat: repeat;
			background-size: 400px 400px;
			animation: twinkle 8s infinite, starMove 1200s linear infinite;
			opacity: 0.3;
		}

		.stars:nth-child(4) {
			background-image: 
				radial-gradient(1px 1px at 35px 45px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 55px 85px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 65px 175px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 105px 55px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 145px 95px, #fff, rgba(0,0,0,0));
			background-repeat: repeat;
			background-size: 250px 250px;
			animation: twinkle 5s infinite, starMove 1200s linear infinite;
			opacity: 0.35;
		}

		.stars:nth-child(5) {
			background-image: 
				radial-gradient(1px 1px at 15px 25px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 35px 65px, #fff, rgba(0,0,0,0)),
				radial-gradient(1px 1px at 45px 155px, #fff, rgba(0,0,0,0)),
				radial-gradient(2px 2px at 85px 35px, #fff, rgba(0,0,0,0)),
				radial-gradient(2px 2px at 125px 75px, #fff, rgba(0,0,0,0));
			background-repeat: repeat;
			background-size: 150px 150px;
			animation: twinkle 7s infinite, starMove 1200s linear infinite;
			opacity: 0.45;
		}


		@keyframes starMove {
			from {
				transform: translateY(-100%);
			}
			to {
				transform: translateY(100%);
			}
		}

        @keyframes twinkle {
            0% {
                opacity: 0.3;
                animation-timing-function: ease-in;
            }
            50% {
                opacity: 0.8;
                animation-timing-function: linear;
            }
            100% {
                opacity: 0.3;
            }
        }

        .stars {
            animation: starMove 120s linear infinite;
        }
		
		.fadeout {
			opacity: 0;
			transition: opacity 2s ease-out;
		}

        /* Hide stars for minimal and elegant styles */
        .minimal #space, .elegant #space {
            display: none;
        }

        /* Elegant background */
        .elegant .background {
            background: linear-gradient(45deg, #1a1a2e, #16213e);
        }

        /* Minimal background */
        .minimal .background {
            background: #000;
        }


		body.visible {
			opacity: 1;
		}

		#app.visible {
			display: block;
		}

		.text-container.animate {
			animation-duration: var(--animation-speed, 600s);
			animation-timing-function: linear;
			animation-fill-mode: forwards;
		}

		/* Ensure proper star visibility control for different styles */
		.minimal .stars, .elegant .stars {
			display: none;
		}

		:root {
			--animation-speed: 600s;
		}

		.footer-text {
			color: var(--text-color, white);
			font-size: 14vh;
			text-align: center;
			padding-top: 20%;
			position: relative;
			z-index: 1;
		}
		
		.footer-text.starwars {
			font-family: 'News Gothic MT', 'News Gothic', sans-serif;
			font-weight: 700;
			letter-spacing: 0.2em;
			text-transform: uppercase;
		}

		.text-container.animate.starwars {
			animation-name: translateText;
			animation-duration: var(--animation-speed, 600s);
			transform-origin: 50% 100%;
		}

		/* StarWars style stays at default speed (long duration) */
		.text-container.animate.starwars {
			animation-name: translateText;
			animation-duration: var(--animation-speed, 600s);
		}

		/* Standard style is much faster */
		.text-container.animate.standard {
			animation-name: standardRoll;
			animation-duration: var(--standard-speed, 120s);
		}

		/* Minimal style is faster */
		.text-container.animate.minimal {
			animation-name: minimalScroll;
			animation-duration: var(--standard-speed, 120s);
		}

		/* Elegant style is faster */
		.text-container.animate.elegant {
			animation-name: elegantFade;
			animation-duration: var(--standard-speed, 120s);
		}

		/* Adjust standardRoll animation to fit shorter duration */
		@keyframes standardRoll {
			0% {
				/* Use dynamic start offset; fallback keeps old behavior */
				transform: translateY(var(--start-offset, 100vh));
			}
			
			100% {
				/* Use dynamic end offset; fallback keeps old behavior */
				transform: translateY(calc(-1 * var(--end-offset, 300vh)));
			}
		}
		


        /* Avatar styles */
        .avatar {
            display: inline-block;
            max-width: 1.45em;
            height: 1.45em;
            border-radius: 50%;
            margin-right: 1vh;
            vertical-align: middle;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
		
		.source-type-img {
			width: 1.4em;
			height: 1.4em;
			vertical-align: middle;
			margin-left: 0.7vh;
			padding-bottom: 0.04em;
		}

        .user-entry {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1vh;
        }

        .user-entry.with-avatar {
            margin-bottom: 2vh;
        }

        .user-info {
            display: inline-block;
            vertical-align: middle;
        }
		
		
		/* Style-specific text styles */
		/* Style-specific text styles */
		.text.standard, .category-header.standard {
			color: var(--text-color, white);
			text-shadow: var(--custom-text-shadow, 0 0 10px rgba(255, 255, 255, 0.5));
		}

		.text.minimal, .category-header.minimal {
			color: var(--text-color, #ffffff);
			text-shadow: var(--custom-text-shadow, none);
		}

		.text.elegant, .category-header.elegant {
			color: var(--text-color, #d3d3d3);
			text-shadow: var(--custom-text-shadow, 0 0 8px rgba(211, 211, 211, 0.6));
		}
	</style>
</head>
<body>
   <div id="app">
        <div class="background"></div>
        <div class="fade"></div>
        <div class="text-container">
            <div class="text" id="credits-content">
                <!-- Content will be inserted here -->
            </div>
            <div class="footer-text" id="endmessage">
                Thank you all for being part of the stream! ❤️
            </div>
        </div>
    </div>
    
    <div id="space">
        <div class="stars"></div>
        <div class="stars"></div>
        <div class="stars"></div>
        <div class="stars"></div>
        <div class="stars"></div>
    </div>

    <script>
	
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const donationPriority = urlParams.has('donationpriority');
    // Session security and network options
    const password = urlParams.get('password') || 'false';
    const lanonly = urlParams.has('lanonly') ? '&lanonly' : '';
	
	// User tracking
	const users = new Map();

	class User {
		constructor(name, type) {
			this.name = name;
			this.type = type;
			this.messageCount = 0;
			this.donations = 0;
			this.isMember = false;
			this.avatarUrl = null;
		}

		get score() {
			return (
				this.messageCount * 1 +
				this.donations * 100 +
				(this.isMember ? 50 : 0)
			);
		}

		get displayName() {
			let badges = [];
			if (this.isMember) badges.push('👑');
			if (this.donations > 0) badges.push('💝');
			if (this.messageCount > 10) badges.push('💬');
			
			const nameDisplay = this.name;
			const badgesDisplay = badges.length > 0 ? badges.join(' ') : '';
			
			const showsourcetype = !urlParams.has('nosourcetype');
			const typeImage = showsourcetype ? `<img src="./sources/images/${this.type}.png" alt="${this.type}" class="source-type-img">` : '';
			
			const showamounts = urlParams.has('showamounts');
			const donationDisplay = (showamounts && this.donations > 0) ? ` ($${this.donations.toFixed(2)})` : '';
			
			return `${nameDisplay} ${badgesDisplay}${typeImage}${donationDisplay}`;
		}

		generateHtml() {
			const showAvatars = urlParams.has('showavatar') || urlParams.has('showavatars');
			
			if (showAvatars && this.avatarUrl) {
				return `<div class="user-entry with-avatar">
					<img src="${this.avatarUrl}" alt="${this.name}" class="avatar">
					<span class="user-info">${this.displayName}</span>
				</div>`;
			} else {
				return `<div class="user-entry">${this.displayName}</div>`;
			}
		}
	}

	function getOrCreateUser(name, type) {
		const key = `${name}-${type}`;
		if (!users.has(key)) {
			users.set(key, new User(name, type));
		}
		return users.get(key);
	}

	function processData(data) {
		if (data.content) {
			data = data.content;
		}

		if (!data.chatname || !data.type) return;

		const onlydonors = urlParams.has('onlydonors');
		if (onlydonors && !data.hasDonation) return;

		const user = getOrCreateUser(data.chatname, data.type);
		user.messageCount++;

		// Store avatar URL if available
		if (data.chatimg) {
			user.avatarUrl = data.chatimg;
		}

		if (data.membership) {
			user.isMember = true;
		}

		if (data.hasDonation) {
			try {
				// Use convertToUSD function to handle donation conversion
				const source = data.type ? data.type.toLowerCase() : '';
				const donationAmount = convertToUSD(data.hasDonation, source);
				
				// Only add if we have a valid amount
				if (!isNaN(donationAmount) && donationAmount > 0) {
					user.donations += donationAmount;
					console.log(`Added donation of ${donationAmount} for ${data.chatname}`);
				} else {
					console.warn(`Invalid donation format for ${data.chatname}:`, data.hasDonation);
				}
			} catch (error) {
				console.error(`Error processing donation for ${data.chatname}:`, error, data.hasDonation);
			}
		}
	}

	function generateCreditsContent() {
		const sortedUsers = Array.from(users.values());
		
		if (donationPriority) {
			// Separate users into donors and non-donors
			const donors = sortedUsers.filter(u => u.donations > 0)
				.sort((a, b) => {
					// First sort by donation amount
					if (b.donations !== a.donations) {
						return b.donations - a.donations;
					}
					// If donation amounts are equal, sort by membership
					if (b.isMember !== a.isMember) {
						return b.isMember - a.isMember;
					}
					// Finally by participation
					return b.messageCount - a.messageCount;
				});
			
			const members = sortedUsers.filter(u => u.donations === 0 && u.isMember)
				.sort((a, b) => b.messageCount - a.messageCount);
			
			const participants = sortedUsers.filter(u => u.donations === 0 && !u.isMember)
				.sort((a, b) => b.messageCount - a.messageCount);
			
			const hidecategories = urlParams.has('hidecategories');
			let content = '';
			
			if (donors.length > 0) {
				content += hidecategories ? "" : `<div class="category-header ${creditsStyle}">Stream Donors</div>`;
				content += donors.map(u => u.generateHtml()).join('') + '<br><br>';
			}
			
			if (members.length > 0) {
				content += hidecategories ? "" : `<div class="category-header ${creditsStyle}">Channel Members</div>`;
				content += members.map(u => u.generateHtml()).join('') + '<br><br>';
			}
			
			if (participants.length > 0) {
				content += hidecategories ? "" : `<div class="category-header ${creditsStyle}">Stream Participants</div>`;
				content += participants.map(u => u.generateHtml()).join('');
			}
			
			return content;
		} else {
			// Original scoring system
			sortedUsers.sort((a, b) => b.score - a.score);
			
			const vips = sortedUsers.filter(u => u.score >= 150);
			const regulars = sortedUsers.filter(u => u.score >= 50 && u.score < 150);
			const participants = sortedUsers.filter(u => u.score < 50);
			
			const hidecategories = urlParams.has('hidecategories');
			let content = '';
			
			if (vips.length > 0) {
				content += hidecategories ? "" : `<div class="category-header ${creditsStyle}">VIP Supporters</div>`;
				content += vips.map(u => u.generateHtml()).join('') + '<br><br>';
			}
			
			if (regulars.length > 0) {
				content += hidecategories ? "" : `<div class="category-header ${creditsStyle}">Regular Supporters</div>`;
				content += regulars.map(u => u.generateHtml()).join('') + '<br><br>';
			}
			
			if (participants.length > 0) {
				content += hidecategories ? "" : `<div class="category-header ${creditsStyle}">Stream Participants</div>`;
				content += participants.map(u => u.generateHtml()).join('');
			}
			
			return content;
		}
	}

	// IFRAME setup for Social Stream Ninja
    const iframe = document.createElement("iframe");
    const filename = "dock";
    iframe.src = "https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&notmobile&notmobile&password=" + encodeURIComponent(password) + lanonly + "&solo&view=" + urlParams.get('session') + "&novideo&noaudio&label=" + filename + "&cleanoutput&room=" + urlParams.get('session');
	iframe.style.width = "0px";
	iframe.style.height = "0px";
	iframe.style.position = "fixed";
	iframe.style.left = "-100px";
	iframe.style.top = "-100px";
	iframe.id = "frame1";
	document.body.appendChild(iframe);

	// Set end message if provided
	const endMessage = urlParams.get('endmessage');
	if (endMessage) {
		document.getElementById("endmessage").innerText = endMessage;
	}
	
	

	// Apply style classes
	const creditsStyle = urlParams.get('style') || "starwars";
	const appElement = document.getElementById('app');
	appElement.classList.add(creditsStyle);
	
	const footerText = document.querySelector('.footer-text');
	footerText.classList.add(creditsStyle);

	// Apply style to text container and content
	const textContainer = document.querySelector('.text-container');
	textContainer.classList.add(creditsStyle);

	// Apply style to all necessary elements
	document.querySelectorAll('.text, .category-header, .footer-text').forEach(el => {
		el.classList.add(creditsStyle);
	});

	if (creditsStyle !== "starwars") {
		if (creditsStyle === "elegant") {
			document.querySelector('.background').style.background = "linear-gradient(45deg, #1a1a2e, #16213e)";
		} else if (creditsStyle === "minimal") {
			document.querySelector('.background').style.background = "#000";
		}
		
		// Hide stars for non-starwars styles
		if (creditsStyle === "minimal" || creditsStyle === "elegant") {
			document.getElementById('space').style.display = "none";
		}
		
		// Remove the star background-image from body immediately
		document.body.style.backgroundImage = "none";
	}

	// Optional: force transparent/no background
	if (urlParams.has('nobg')) {
		// Ensure the body itself is transparent
		document.body.style.background = '#0000';
		document.body.style.backgroundImage = 'none';
		// Hide overlay background layers that might still be visible
		const bgLayer = document.querySelector('.background');
		if (bgLayer) bgLayer.style.display = 'none';
		const fadeLayer = document.querySelector('.fade');
		if (fadeLayer) fadeLayer.style.display = 'none';
		// Keep star field for Star Wars only; hide stars otherwise
		if (creditsStyle !== 'starwars') {
			const spaceEl = document.getElementById('space');
			if (spaceEl) spaceEl.style.display = 'none';
		}
	}


	// Set animation speed
	const speed = parseFloat(urlParams.get('speed') || "1");
	const durationParam = parseFloat(urlParams.get('duration') || "");

	// Duration has priority over speed if provided
	if (Number.isFinite(durationParam) && durationParam > 0) {
		const fixedDuration = `${durationParam}s`;
		document.documentElement.style.setProperty('--animation-speed', fixedDuration);
		document.documentElement.style.setProperty('--standard-speed', fixedDuration);
	} else if (speed !== 1) {
		// If speed parameter is provided, apply it to both animation types
		const starWarsSpeed = `${600 / speed}s`;
		const standardSpeed = `${60 / speed}s`;
		
		document.documentElement.style.setProperty('--animation-speed', starWarsSpeed);
		document.documentElement.style.setProperty('--standard-speed', standardSpeed);
	} else {
		// Default speeds if no speed parameter provided
		document.documentElement.style.setProperty('--animation-speed', '600s');
		document.documentElement.style.setProperty('--standard-speed', '60s');
	}
	
	const textColor = urlParams.get('textcolor');

	if (textColor) {
		document.documentElement.style.setProperty('--text-color', textColor);
		
		// Create matching text shadow for custom color
		const r = parseInt(textColor.slice(1, 3), 16);
		const g = parseInt(textColor.slice(3, 5), 16);
		const b = parseInt(textColor.slice(5, 7), 16);
		
		// Generate a glow effect based on the custom color
		const textShadow = `0 0 16px rgba(${r}, ${g}, ${b}, 0.6), 0 0 3px rgba(${r}, ${g}, ${b}, 0.8), 0 0 10px rgba(255, 255, 255, 0.3)`;
		document.documentElement.style.setProperty('--custom-text-shadow', textShadow);
		
		// Apply shadow to all text elements including footer
		const footerText = document.querySelector('.footer-text');
		footerText.style.textShadow = textShadow;
	}


	// Apply custom font if specified
	const fontFamily = urlParams.get('font') || "Nunito Sans";
	const googlefont = urlParams.get('googlefont');

	if (googlefont) {
		// Load Google font
		const link = document.createElement('link');
		link.rel = 'stylesheet';
		link.href = `https://fonts.googleapis.com/css2?family=${encodeURIComponent(googlefont)}&display=swap`;
		document.head.appendChild(link);
		
		// Apply the font to body, app element, and footer
		document.body.style.fontFamily = `'${googlefont}', sans-serif`;
		appElement.style.fontFamily = `'${googlefont}', sans-serif`;
		footerText.style.fontFamily = `'${googlefont}', sans-serif`;
	} else if (fontFamily) {
		// Apply predefined font to body, app element, and footer
		document.body.style.fontFamily = `'${fontFamily}', sans-serif`;
		appElement.style.fontFamily = `'${fontFamily}', sans-serif`;
		footerText.style.fontFamily = `'${fontFamily}', sans-serif`;
		
		// Load the OpenDyslexic font if specified
		if (fontFamily === 'opendyslexic') {
			const link = document.createElement('link');
			link.rel = 'stylesheet';
			link.href = 'https://fonts.cdnfonts.com/css/opendyslexic';
			document.head.appendChild(link);
		}
	}

    // Handle message events
    const eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
    const eventer = window[eventMethod];
    const messageEvent = eventMethod === "attachEvent" ? "onmessage" : "message";
    eventer(messageEvent, function (e) {
        if (e.source != iframe.contentWindow) return;
        if ("dataReceived" in e.data) {
            if ("overlayNinja" in e.data.dataReceived) {
                processData(e.data.dataReceived.overlayNinja);
            }
        }
    });

    // Optional: Extension server relay (server2/server3) for dock-labeled pages
    (function setupExtensionSocket(){
        if (!(urlParams.has('server2') || urlParams.has('server3'))) return;
        let serverURL = urlParams.has('server2') ? (urlParams.get('server2') || 'wss://io.socialstream.ninja/extension') : (urlParams.get('server3') || 'wss://io.socialstream.ninja/extension');
        let socket = null;
        let attempts = 1;
        function connect(){
            if (socket) {
                socket.onclose = null; try { socket.close(); } catch(e){}
            }
            socket = new WebSocket(serverURL);
            socket.onopen = function(){
                attempts = 1;
                const session = (urlParams.get('session') || '').split(',')[0];
                socket.send(JSON.stringify({ join: session, out: 3, in: 4 }));
            };
            socket.onclose = function(){
                setTimeout(connect, 100 * attempts++);
            };
            socket.onerror = function(){ try { socket.close(); } catch(e){} };
            socket.addEventListener('message', function(event){
                if (!event.data) return;
                try {
                    const data = JSON.parse(event.data);
                    processData(data);
                    if (data.get) {
                        const ret = { callback: { get: data.get, result: true } };
                        socket.send(JSON.stringify(ret));
                    }
                } catch(e) { /* ignore parse errors */ }
            });
        }
        connect();
    })();

	// Shared helpers for visibility toggles
	const creditsContent = document.getElementById('credits-content');

	function applyAdaptiveOffsets() {
		try {
			const viewportHeight = appElement.clientHeight || window.innerHeight;
			const paddingTop = parseFloat(getComputedStyle(textContainer).paddingTop) || 0;
			const contentHeight = creditsContent ? creditsContent.scrollHeight : 0;
			const footerHeightValue = footerText ? footerText.scrollHeight : 0;
			const startPx = (creditsStyle === 'elegant') ? (0.5 * viewportHeight) : (1.0 * viewportHeight);
			const extraOutPx = Math.round(0.25 * viewportHeight);
			const endPx = paddingTop + contentHeight + footerHeightValue + extraOutPx;

			textContainer.style.setProperty('--start-offset', `${Math.round(startPx)}px`);
			textContainer.style.setProperty('--end-offset', `${Math.max(0, Math.round(endPx))}px`);
		} catch (e) {
			console.warn('Could not compute adaptive scroll offsets:', e);
		}
	}

	function restartScrollAnimation() {
		textContainer.classList.remove('fadeout');
		textContainer.classList.remove('animate');
		void textContainer.offsetWidth;
		textContainer.classList.add('animate');
	}

	function startCredits() {
		creditsContent.innerHTML = generateCreditsContent();
		document.body.classList.add('visible');
		appElement.classList.add('visible');

		const startAnimation = () => {
			applyAdaptiveOffsets();
			restartScrollAnimation();
		};

		if (document.fonts && document.fonts.ready) {
			document.fonts.ready.then(startAnimation).catch(startAnimation);
		} else {
			setTimeout(startAnimation, 100);
		}
	}

	function stopCredits(options = {}) {
		const keepFadeout = options.keepFadeout || false;
		if (!keepFadeout) {
			textContainer.classList.remove('fadeout');
		}
		textContainer.classList.remove('animate');
		appElement.classList.remove('visible');
		document.body.classList.remove('visible');
	}

	function handleVisibilityState(visible) {
		if (visible) {
			startCredits();
		} else {
			stopCredits();
		}
	}

	document.addEventListener('visibilitychange', function () {
		handleVisibilityState(!document.hidden);
	});

	if (window.obsstudio) {
		try {
			const existingVisibilityHandler = window.obsstudio.onVisibilityChange;
			window.obsstudio.onVisibilityChange = function (visible) {
				handleVisibilityState(!!visible);
				if (typeof existingVisibilityHandler === 'function') {
					existingVisibilityHandler(visible);
				}
			};

			if ('onActiveChange' in window.obsstudio) {
				const existingActiveHandler = window.obsstudio.onActiveChange;
				window.obsstudio.onActiveChange = function (active) {
					if (typeof active === 'boolean') {
						handleVisibilityState(active);
					}
					if (typeof existingActiveHandler === 'function') {
						existingActiveHandler(active);
					}
				};
			}
		} catch (err) {
			console.warn('OBS visibility callbacks unavailable:', err);
		}
	} else if (!document.hidden) {
		// Non-OBS environments: start immediately so manual previews still work.
		startCredits();
	}

	// Handle animation end
	document.querySelector('.text-container').addEventListener('animationend', function() {
		// Clear collected names when animation completes
		users.clear();

		// Apply fadeout class
		this.classList.add('fadeout');

		// Hide the app while keeping the fadeout applied
		stopCredits({ keepFadeout: true });
	});
    </script>
</body>
</html>
