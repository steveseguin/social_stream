name: Firefox Add-on Store Submission

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      channel:
        description: AMO channel (unlisted = immediate signing, listed = store review)
        type: choice
        options: [listed, unlisted]
        default: listed

permissions:
  contents: write

env:
  FIREFOX_BUILD_DIR: firefox-build
  ARTIFACTS_DIR: web-ext-artifacts
  FIREFOX_BRANCH: firefox
  FIREFOX_FILE_NAME: social-stream-ninja.xpi

jobs:
  submit-firefox-addon:
    if: github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, '[skip firefox]')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Read manifest version
        id: manifest
        run: |
          set -euo pipefail
          VERSION=$(jq -r '.version' manifest.json)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Prepare Firefox build
        run: |
          set -euo pipefail
          chmod +x scripts/prepare-chrome-web-store.sh
          chmod +x scripts/prepare-firefox.sh
          ./scripts/prepare-firefox.sh

      - name: Install web-ext CLI
        run: npm install --global web-ext@8

      - name: Submit to Firefox Add-ons Store
        env:
          AMO_JWT_ISSUER: ${{ secrets.AMO_JWT_ISSUER }}
          AMO_JWT_SECRET: ${{ secrets.AMO_JWT_SECRET }}
          WEB_EXT_CHANNEL: ${{ github.event.inputs.channel || 'listed' }}
        run: |
          set -euo pipefail

          if [[ -z "${AMO_JWT_ISSUER:-}" || -z "${AMO_JWT_SECRET:-}" ]]; then
            echo "AMO credentials missing. Set AMO_JWT_ISSUER and AMO_JWT_SECRET secrets." >&2
            exit 1
          fi

          mkdir -p "${ARTIFACTS_DIR}"
          rm -f "${ARTIFACTS_DIR}"/*.xpi || true

          echo "Submitting to AMO (channel: ${WEB_EXT_CHANNEL})..."

          attempt=1
          max_attempts=4
          backoff=30
          success=false

          until web-ext sign \
            --api-key "$AMO_JWT_ISSUER" \
            --api-secret "$AMO_JWT_SECRET" \
            --channel "$WEB_EXT_CHANNEL" \
            --source-dir "$FIREFOX_BUILD_DIR" \
            --artifacts-dir "$ARTIFACTS_DIR" \
            --amo-metadata "scripts/amo-metadata.json" \
            --approval-timeout 0; do
            if (( attempt >= max_attempts )); then
              echo "web-ext sign failed after ${attempt} attempts" >&2
              break
            fi
            echo "web-ext sign failed (attempt ${attempt}/${max_attempts}). Retrying in ${backoff}s..." >&2
            sleep "$backoff"
            attempt=$((attempt + 1))
            backoff=$((backoff * 2))
          done

          if ls "${ARTIFACTS_DIR}"/*.xpi >/dev/null 2>&1; then
            echo "Submission successful!"
            success=true
          fi

          if [[ "${success}" != "true" ]]; then
            echo "Submission failed after all attempts." >&2
            exit 1
          fi

      - name: Upload signed XPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-addon-${{ steps.manifest.outputs.version }}
          path: ${{ env.ARTIFACTS_DIR }}/*.xpi
          if-no-files-found: error

      - name: Publish XPI to firefox branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          XPI_PATH=$(ls "$GITHUB_WORKSPACE/${ARTIFACTS_DIR}"/*.xpi | head -n 1)
          if [[ -z "${XPI_PATH:-}" ]]; then
            echo "Signed XPI not found" >&2
            exit 1
          fi

          TMP_DIR=$(mktemp -d)
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git clone --depth 1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" "$TMP_DIR"

          cd "$TMP_DIR"
          git checkout --orphan "$FIREFOX_BRANCH"
          find . -mindepth 1 -not -path './.git' -not -path './.git/*' -exec rm -rf {} + || true
          cp "$XPI_PATH" "$FIREFOX_FILE_NAME"
          git add "$FIREFOX_FILE_NAME"
          git commit -m "Firefox Add-on v${{ steps.manifest.outputs.version }}"
          git push -f origin "$FIREFOX_BRANCH"

          echo "Published to branch '$FIREFOX_BRANCH'"
          echo "Direct link: https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${FIREFOX_BRANCH}/${FIREFOX_FILE_NAME}"

      - name: Upload XPI to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          VERSION="${{ steps.manifest.outputs.version }}"
          XPI_PATH=$(ls "$GITHUB_WORKSPACE/${ARTIFACTS_DIR}"/*.xpi | head -n 1)
          XPI_NAME="socialstreamninja_firefox_v${VERSION}.xpi"

          # Check if a release exists for this version (try with and without 'v' prefix)
          RELEASE_TAG=""
          if gh release view "${VERSION}" &>/dev/null; then
            RELEASE_TAG="${VERSION}"
          elif gh release view "v${VERSION}" &>/dev/null; then
            RELEASE_TAG="v${VERSION}"
          elif gh release view "0.${VERSION#*.}" &>/dev/null; then
            RELEASE_TAG="0.${VERSION#*.}"
          fi

          if [[ -n "$RELEASE_TAG" ]]; then
            echo "Found release: $RELEASE_TAG"
            # Remove existing Firefox XPI if present
            gh release delete-asset "$RELEASE_TAG" "$XPI_NAME" --yes 2>/dev/null || true
            # Upload new XPI
            gh release upload "$RELEASE_TAG" "$XPI_PATH#$XPI_NAME"
            echo "Uploaded $XPI_NAME to release $RELEASE_TAG"
          else
            echo "No release found for version ${VERSION}, skipping release upload"
            echo "XPI is available in the firefox branch and as a workflow artifact"
          fi

      - name: Upload submission logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: firefox-submission-logs-${{ github.run_id }}
          path: ${{ env.ARTIFACTS_DIR }}/*.log
          if-no-files-found: ignore
