<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Overlay</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Host+Grotesk:wght@300..800&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 22, 40, 0.8);
            font-family: 'Host Grotesk', sans-serif;
            background-color: #0000;
        }

        #chat-container {
            padding-top: 25px;
            margin: 0px;
            display: flex;
            flex-flow: column wrap;
            overflow: hidden;
            max-height: 100%;
            width: 400px;
            min-width: 400px;
        }

        .message-container {
            position: relative;
            margin-bottom: 20px;
            min-width: 400px;
        }
		
		.badges:empty, span:empty, .text:empty, .donation:empty {
			display:none;
		}

        .username-box {
            display: flex;
            position: absolute;
            max-height: 1.6rem;
            top: -19px;
            left: -8px;
            padding: 4px 8px;
            border-radius: 8px;
            color: #ffffff;
            font-weight: 600;
            z-index: 2;
            font-size: clamp(0.85em, 2.5vw, 1.1em);
            min-width: 1.9em;
        }
		
		.username-box span {
			display:inline-block;
		}
		
		.donation {
			padding: 7px 18px 5px 18px;
			color: white;
		}

        .badge {
            height: 1em;
            vertical-align: middle;
            margin-left: 4px;
        }

        .message {
            display: inline-block;
            min-height: 1.25rem;
            max-height: 120px;
            max-width: 90%;
            background: linear-gradient(90deg, #555, color-mix(in srgb, #555A 90%, #000A));
            padding: 14px 14px 8px 14px;
            margin-top: 6px;
            margin-left: 15px;
            margin-right: 15px;
            border-radius: 10px;
            color: #ffffff;
            opacity: 0;
            transform: translateY(-20px);
            animation: slideFadeIn 0.5s ease forwards;
            position: relative;
            word-wrap: break-word;
        }

        .text {
            font-size: clamp(0.85em, 2.5vw, 1em);
            line-height: 1.4;
        }
        .badges {
            display: flex;
            align-items: center;
        }
		.badges svg, .badges img, .text svg, .text img {
			max-width:64px;
			max-height:24px;
		}
        .badges .textbadge {
            border-radius: 6px;
            padding: 0 5px;
            font-size: 50%;
            width: max-content;
            background: rgba(0, 0, 0, 0.15);
            width: max-content;
            padding: 1px 3px 3px 3px;
        }

        .avatar {
            padding: 0.7em;
            margin-right: 4px;
            background-size: contain;
            border-radius: 1em;
        }

        @keyframes slideFadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <script type="text/javascript" src="chroma.min.cjs"></script>
</head>
<body>
    <div id="chat-container"></div>

    <script>
    // Parameters for Social Stream Ninja
    var urlParams = new URLSearchParams(window.location.search);
    var roomID = "4DP7Stjuew"; // Default Room ID

    if (urlParams.has("session")) {
        roomID = urlParams.get("session");
    }
    var password = "false"; // Set password if needed
    var featuredMode = false; // Set to true if you only want to display featured messages

    const chatContainer = document.getElementById('chat-container');

    // Function to add a dynamic message to the overlay
    function addMessageToOverlay(data) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');
        
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        //const { h, s, l } = rgbToHsl(data.nameColor);
        //messageDiv.style.background = `linear-gradient(90deg, ${hslToRgb(h, 50, l)}, ${data.nameColor})`;
        messageDiv.style.background = `linear-gradient(90deg, ${chroma(data.nameColor).desaturate(4).darken(1).alpha(0.8)}, ${chroma(data.nameColor).desaturate(3).darken(1).alpha(0.8)})`;
        if (data.mid) messageDiv.id = data.mid;
        data.sourceicon = `https://socialstream.ninja/sources/images/${data.type}.png`;

        // Build the badges HTML
        let chatbadges = "";
        if (data.chatbadges) {
            console.log(data.chatbadges);
            data.chatbadges.slice(0, 5).forEach(badge => {
                if (typeof badge === "object") {
                    if (badge.type === "img" && badge.src) {
                        chatbadges += `<img class='badge' src='${badge.src}' />`;
                    } else if (badge.type === "svg" && badge.html) {
                        chatbadges += `<span class='badge svg'>${badge.html}</span>`;
                    } else if (badge.type === "text" && badge.text) {
                        chatbadges += `<span class='badge textbadge'>${badge.text}</span>`;
                    }
                } else {
                    chatbadges += `<img class='badge' src='${badge}' />`;
                }
            });
        }

        // Construct the HTML for each message
        messageDiv.innerHTML = `
            <div class="username-box" style="background: linear-gradient(90deg, ${chroma(data.nameColor).desaturate(1).alpha(0.9)}, ${chroma(data.nameColor).desaturate(2).alpha(0.9)});">
                ${data.chatimg ? `<div class="avatar-wrapper"><div class="avatar" style="background-image: url('${data.chatimg}');"></div></div>` : ''}
                <span>${data.chatname}</span>
                <div class="badges">${chatbadges}</div>
            </div>
            <div class="text">${data.chatmessage || ''}</div>
            ${(data.donation||data.hasDonation) ? `<div class="donation">${(data.donation||data.hasDonation)}</div>` : ''}
        `;

        messageContainer.appendChild(messageDiv);
        chatContainer.prepend(messageContainer);
        

        // Auto-scroll to the latest message
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Remove oldest messages if over limit
        if (chatContainer.children.length > 20) {
            chatContainer.removeChild(chatContainer.lastChild);
        }
			
        setTimeout(() => {
            Array.from(chatContainer.children).forEach(child => {
                child.style.transform = '';
            });
        }, 500); 
    }

    document.addEventListener('DOMContentLoaded', () => {
			
			var iframe = document.createElement("iframe");
			if (featuredMode){
				iframe.src = `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`;
			} else {
				iframe.src = "https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password="+password+"&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room="+roomID; 
			}
			
			iframe.style.cssText = "width: 0px; height: 0px; position: fixed; left: -100px; top: -100px; overflow: hidden;";
			document.body.appendChild(iframe);

			window.addEventListener("message", function (e) {
				if (e.source != iframe.contentWindow) return;
				if (e.data.dataReceived && e.data.dataReceived.overlayNinja) {
					addMessageToOverlay(e.data.dataReceived.overlayNinja);
				}
			});

		});
</script>
</body>
</html>